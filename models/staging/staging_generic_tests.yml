{% set stg_generic_models = (
     graph.nodes.values()
     | selectattr('tags', 'contains', ['staging_generic_tests'])
     | map(attribute='name')
     | list
) %}

version: 2

{% for model_name in stg_generic_models %}
  - name: {{ model_name }}

    # ---------- TABLE-LEVEL TESTS ----------
    tests:
      # Reject empty tables (alerts if the ingestion broke)
      - dbt_expectations.expect_table_row_count_to_be_greater_than:
          value: 0
          severity: warn        # fail in CI

      # Check freshness of processed data (within 2 days)
      - dbt_utils.recency:
          datepart: day
          field: processed_at
          interval: 2
          severity: warn

    # ---------- COLUMN-LEVEL TESTS ----------
    columns:
      - name: processed_at
        tests: [not_null]

      - name: validator
        tests: [not_null]

{% endfor %}